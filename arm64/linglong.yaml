version: "1"

package:
  id: org.deepin.driver.display.nvidia.580-119-02
  name: NVIDIA-Linux-aarch64-580.119.02
  version: 1.0.0.1
  kind: extension
  description: |
    nvidia display driver version 580.119.02
  libs: [orig]
  env:
    __EGL_VENDOR_LIBRARY_DIRS: $PREFIX/glvnd/egl_vendor.d:$ORIGIN
    __EGL_EXTERNAL_PLATFORM_CONFIG_DIRS: $PREFIX/egl/egl_external_platform.d
    VK_ADD_DRIVER_FILES: $PREFIX/vulkan/icd.d/nvidia_icd.json

base: org.deepin.base/25.2.0 #set the base environment, this can be changed.

sources:
  - kind: file
    url: https://ci.deepin.com/repo/deepin/deepin-community/stable/pool/commercial/n/nvidia-graphics-drivers/nvidia-graphics-drivers_580.119.02.orig.tar.xz
    digest: 4ae25fe11e831c8f4759b98f62bb34e40590cbdb5fbeed3cb53a88ba611a0159
    name: nvidia-graphics-drivers.tar.xz

build: |
  mkdir -p nvidia-graphics-drivers
  tar --no-same-owner -xf /project/linglong/sources/nvidia-graphics-drivers.tar.xz -C nvidia-graphics-drivers

  driver_name=NVIDIA-Linux-aarch64-580.119.02

  rm -rf ${driver_name}

  bash "nvidia-graphics-drivers/arm64/${driver_name}.run" -x

  mkdir -p $PREFIX/orig
  cp -r "${driver_name}"/* $PREFIX/orig/

  mkdir -p $PREFIX/glvnd/egl_vendor.d/
  ln -st $PREFIX/glvnd/egl_vendor.d/ $PREFIX/orig/10_nvidia.json

  mkdir -p $PREFIX/egl/egl_external_platform.d/
  ln -st $PREFIX/egl/egl_external_platform.d/ $PREFIX/orig/10_nvidia.json
  ln -st $PREFIX/egl/egl_external_platform.d/ $PREFIX/orig/15_nvidia_gbm.json
  ln -st $PREFIX/egl/egl_external_platform.d/ $PREFIX/orig/20_nvidia_xcb.json
  ln -st $PREFIX/egl/egl_external_platform.d/ $PREFIX/orig/20_nvidia_xlib.json

  mkdir -p $PREFIX/vulkan/icd.d/
  ln -st $PREFIX/vulkan/icd.d/ $PREFIX/orig/nvidia_icd.json

  mkdir -p $PREFIX/etc
  cat << EOF > $PREFIX/etc/ld.so.conf
  /opt/extensions/org.deepin.driver.display.nvidia.580-119-02/orig
  EOF

  ldconfig

  echo 'build done
