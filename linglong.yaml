version: "1"

package:
  id: org.deepin.driver.display.nvidia.580-105-08
  name: NVIDIA-Linux-x86_64-580.105.08
  version: 1.0.0.0
  kind: extension
  description: |
    nvidia display driver version 580.105.08

base: org.deepin.base/23.1.0 #set the base environment, this can be changed.

sources:
  - kind: file
    url: https://ci.deepin.com/repo/deepin/deepin-community/stable/pool/main/n/nvidia-graphics-drivers/nvidia-graphics-drivers_580.105.08.orig.tar.xz
    digest: 0384bd59c898e3f7c689e8248025d585f8ffa224137d3d4745dad9294789d1ed
    name: nvidia-graphics-drivers.tar.xz

build: |
  mkdir -p nvidia-graphics-drivers
  tar --no-same-owner -xf /project/linglong/sources/nvidia-graphics-drivers.tar.xz -C nvidia-graphics-drivers

  driver_name=NVIDIA-Linux-x86_64-580.105.08

  rm -rf ${driver_name}

  bash "nvidia-graphics-drivers/amd64/${driver_name}.run" -x

  mkdir -p $PREFIX/orig
  cp -r "${driver_name}"/* $PREFIX/orig/

  mkdir -p $PREFIX/glvnd/egl_vendor.d/
  ln -st $PREFIX/glvnd/egl_vendor.d/ $PREFIX/orig/10_nvidia.json

  mkdir -p $PREFIX/egl/egl_external_platform.d/
  ln -st $PREFIX/egl/egl_external_platform.d/ $PREFIX/orig/10_nvidia.json
  ln -st $PREFIX/egl/egl_external_platform.d/ $PREFIX/orig/15_nvidia_gbm.json
  ln -st $PREFIX/egl/egl_external_platform.d/ $PREFIX/orig/20_nvidia_xcb.json
  ln -st $PREFIX/egl/egl_external_platform.d/ $PREFIX/orig/20_nvidia_xlib.json

  mkdir -p $PREFIX/vulkan/icd.d/
  ln -st $PREFIX/vulkan/icd.d/ $PREFIX/orig/nvidia_icd.json

  mkdir -p $PREFIX/etc
  cp ld.so.conf $PREFIX/etc/

  ldconfig

  echo 'build done'
